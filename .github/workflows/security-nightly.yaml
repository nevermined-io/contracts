name: Security Tests Run Nightly

# TODO: ENABLE NIGHTLY EXECUTION WHEN TESTS ARE OKAY
#on:
#  schedule:
#    - cron:  '30 2 * * *'
on: push

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - uses: actions/setup-node@v1
              with:
                  node-version: '14.x'
            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v1
              with:
                  python-version: '3.7'
            - name: Pre-install
              run: |
                  rm -rf node_modules
                  yarn install --frozen-lockfile
                  git submodule init
                  git submodule update
            - name: Compile and Lint
              run: |
                  yarn clean
                  yarn compile
            - name: Flattening contracts
              run: |
                  sh ./scripts/hardhat-flattener.sh
            - name: Run Slither
              run: |
                  pip install slither-analyzer
                  yarn clean
                  yarn security:slither
                  echo '\n## SLITHER REPORT :rocket:\n\n' >> $GITHUB_STEP_SUMMARY
                  cat slitherReport.txt >> $GITHUB_STEP_SUMMARY
            - name: Archive Slyther report
              uses: actions/upload-artifact@v3
              with:
                  name: slither-report
                  path: slitherReport.txt
            - name: Run Mythril
              run: |
                  pip install mythril
                  yarn security:mythril
                  echo '\n## MYTHRIL REPORT :rocket:\n\n' >> $GITHUB_STEP_SUMMARY
                  cat mythrilReport.txt >> $GITHUB_STEP_SUMMARY
            - name: Archive Mythril report
              uses: actions/upload-artifact@v3
              with:
                  name: mythril-report
                  path: mythrilReport.txt
              env:
                  NODE_OPTIONS: "--max-old-space-size=7500"
#
#    slither:
#        needs: build
#        runs-on: ubuntu-latest
#        steps:
#            - name: Run Slither
#              run: |
#                  pip install slither-analyzer
#                  yarn clean
#                  cd ..
#                  yarn security:slither
#                  echo '\n## SLITHER REPORT :rocket:\n\n' >> $GITHUB_STEP_SUMMARY
#                  cat slitherReport.txt >> $GITHUB_STEP_SUMMARY
#            - name: Archive report
#              uses: actions/upload-artifact@v3
#              with:
#                  name: slither-report
#                  path: slitherReport.txt
#
#    mythril:
#        needs: build
#        runs-on: ubuntu-latest
#        steps:
#            - name: Run Mythril
#              run: |
#                  pip install mythril
#                  cd ..
#                  yarn security:mythril
#                  echo '\n## MYTHRIL REPORT :rocket:\n\n' >> $GITHUB_STEP_SUMMARY
#                  cat mythrilReport.txt >> $GITHUB_STEP_SUMMARY
#            - name: Archive report
#              uses: actions/upload-artifact@v3
#              with:
#                  name: mythril-report
#                  path: mythrilReport.txt
